<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Calendar | Upcoming Events</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="event.css">
  <link rel="stylesheet" href="index.css">
</head>
<body>
<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" id="menuToggle">
  <i class="fas fa-bars"></i>
</button>

<!-- Sidebar Navigation -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="https://cdn-icons-png.flaticon.com/512/3652/3652191.png" alt="Smart Calendar Logo">
    <h2>Smart Calendar</h2>
  </div>

  <ul class="nav-menu">
    <li class="nav-item">
      <a href="index.html" class="nav-link">
        <i class="fas fa-calendar-alt"></i>
        <span>Calendar</span>
      </a>
    </li>
  </ul>

</aside>

<!-- Main Content -->
<main class="main-content">
  <header class="header">
    <h1>Upcoming Events</h1>

    <div class="user-profile">
      <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User Profile">
      <div class="user-info">
        <h4 id="usernameDisplay"></h4>
      </div>
    </div>
  </header>

  <!-- Events List -->
  <section id="eventsList" class="events-list">
    <!-- Events will be loaded here -->
  </section>
</main>

<script>
  // Mobile Menu Toggle
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');

  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
  });

  // Load events when page loads
  document.addEventListener('DOMContentLoaded', async () => {
    const username = getCookie('userName');
    document.getElementById('usernameDisplay').textContent = username;

    try {
      const response = await fetch("http://localhost:8081/api/GetAllEvents", {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });

      if (response.ok) {
        const eventsDTO = await response.json();
        displayEvents(eventsDTO);
      } else {
        alert('Failed to load upcoming events.');
      }
    } catch (error) {
      console.error('Error fetching events:', error);
      alert('Error loading upcoming events.');
    }
  });

  function displayEvents(eventsDTO) {
    const eventsList = document.getElementById('eventsList');
    eventsList.innerHTML = '';

    if (eventsDTO.length === 0) {
      eventsList.innerHTML = '<p class="no-events">No upcoming events found.</p>';
      return;
    }

    eventsDTO.forEach(event => {
      const eventElement = document.createElement('div');
      eventElement.classList.add('event-card');
      eventElement.innerHTML = `
    <div class="event-card-body">
        <div class="event-header">
            <h3>${event.title}</h3>
        </div>
        <div class="event-details">
            <p><i class="fas fa-calendar-day"></i> <strong>Date:</strong> ${event.date}</p>
            <p><i class="fas fa-clock"></i> <strong>Time:</strong> ${event.time}</p>
            <p><i class="fas fa-align-left"></i> <strong>Description:</strong> ${event.description || 'No description'}</p>
            <div class="event-actions">
                <button class="edit-btn" data-id="${event.eventId}" data-title="${event.title}" data-date="${event.date}" data-time="${event.time}" data-description="${event.description || ''}">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn" data-id="${event.eventId}">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button class="invite-btn" data-id="${event.eventId}">
                    <i class="fas fa-user-plus"></i> Invite
                </button>
                 <button class="reminder-btn" data-id="${event.eventId}">
                    <i class="fas fa-edit"></i> Add Reminder
                </button>
            </div>
        </div>
    </div>
`;
      eventsList.appendChild(eventElement);
    });
    setupEditForms();
    setupDeleteButton();
    setupInviteButtons();
    setupReminderEditButtons();

  }




  function setupEditForms() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const eventId = e.currentTarget.getAttribute('data-id');
        const eventCard = e.currentTarget.closest('.event-card');
        const eventDetails = eventCard.querySelector('.event-details');

        // Get current values
        const title = e.currentTarget.getAttribute('data-title');
        const date = e.currentTarget.getAttribute('data-date');   // YYYY-MM-DD
        const time = e.currentTarget.getAttribute('data-time');   // HH:MM
        const description = e.currentTarget.getAttribute('data-description') || '';


        // Create edit form
        const editForm = document.createElement('div');
        editForm.classList.add('edit-form');
        editForm.innerHTML = `
          <div class="form-group">
              <label>Title</label>
              <input type="text" class="edit-title" value="${title}">
          </div>
          <div class="form-row">
              <div class="form-group">
                  <label>Date</label>
                  <input type="date" class="edit-date" value="${date}">
              </div>
              <div class="form-group">
                  <label>Time</label>
                  <input type="time" class="edit-time" value="${time}">
              </div>
          </div>
          <div class="form-group">
              <label>Description</label>
              <textarea class="edit-description">${description === 'No description' ? '' : description}</textarea>
          </div>
          <div class="form-actions">
              <button class="save-btn">Save</button>
              <button class="cancel-btn">Cancel</button>
          </div>
        `;

        // Replace content with edit form
        eventCard.querySelector('.event-card-body').style.display = 'none';
        eventCard.appendChild(editForm);

        // Save button handler
        editForm.querySelector('.save-btn').addEventListener('click', async () => {
          const updatedEvent = {
            title: editForm.querySelector('.edit-title').value,
            date: editForm.querySelector('.edit-date').value,
            time: editForm.querySelector('.edit-time').value,
            description: editForm.querySelector('.edit-description').value
          };


          try {
            const response = await fetch(`http://localhost:8081/api/Edit_Event/${eventId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(updatedEvent),
              credentials: 'include'
            });

            if (response.ok) {
              location.reload();
            }
            else {
              const error = await response.text();
              alert(`Failed to update event: ${error}`);
            }
          }
          catch (error) {
            console.error('Error:', error);
            alert('Error updating event.');
          }
        });

        // Cancel button handler
        editForm.querySelector('.cancel-btn').addEventListener('click', () => {
          eventCard.removeChild(editForm);
          eventCard.querySelector('.event-card-body').style.display = 'block';
        });
      });
    });
  }





  function setupDeleteButton() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const eventId = e.currentTarget.getAttribute('data-id');

        if (!confirm('Are you sure you want to delete this event?')) {
          return;
        }

        try {
          const response = await fetch(`http://localhost:8081/api/Delete_Event/${eventId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (response.ok){
            alert('Event deleted successfully!');
            location.reload();
          } else {
            const error = await response.text();
            alert(`Failed to delete event: ${error}`);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error deleting event.');
        }
      });
    });
  }





  function setupInviteButtons() {
    document.querySelectorAll('.invite-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const eventId = e.currentTarget.getAttribute('data-id');
        const eventCard = e.currentTarget.closest('.event-card');

        const inviteForm = document.createElement('div');
        inviteForm.classList.add('invite-form');
        inviteForm.innerHTML = `
        <div class="form-group">
          <label>Email to invite</label>
          <input type="email" class="invite-email" placeholder="Enter email address">
        </div>
        <div class="form-actions">
          <button class="send-invite-btn">Send Invitation</button>
          <button class="cancel-invite-btn">Cancel</button>
        </div>

      `;

        eventCard.querySelector('.event-card-body').style.display = 'none';
        eventCard.appendChild(inviteForm);

        inviteForm.querySelector('.send-invite-btn').addEventListener('click', async () => {
          const email = inviteForm.querySelector('.invite-email').value;

          if (!email) {
            alert('Please enter an email address');
            return;
          }

            const response = await fetch(`http://localhost:8081/api/Add_Invitation/${eventId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ email }),
              credentials: 'include'
            });

            if (response.ok) {
              const resultText = await response.text();
              if (resultText === "SUCCESS") {
                alert('Invitation Sent Successfully!');
                eventModal.classList.remove('active');
                eventForm.reset();
              }
              else if (resultText === "THIS EMAIL IS NOT FOUND")
                alert('This Email Is Not Found!');
            }

        }
        );

        inviteForm.querySelector('.cancel-invite-btn').addEventListener('click', () => {
          eventCard.removeChild(inviteForm);
          eventCard.querySelector('.event-card-body').style.display = 'block';
        });
      });
    });
  }

  function setupReminderEditButtons() {
    document.querySelectorAll('.reminder-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const eventId = e.currentTarget.getAttribute('data-id');
        const eventCard = e.currentTarget.closest('.event-card');

        // Create the reminder edit form
        const reminderForm = document.createElement('div');
        reminderForm.classList.add('reminder-form');
        reminderForm.innerHTML = `
        <div class="form-group">
          <label>Edit Reminder Time</label>
          <div class="time-input">
            <input type="number" class="reminder-hours" min="0" max="23" placeholder="0">
            <span>hours</span>
            <input type="number" class="reminder-minutes" min="0" max="59" placeholder="0">
            <span>minutes</span>
          </div>
        </div>
        <div class="form-actions">
          <button class="save-reminder-btn">Save Reminder</button>
          <button class="cancel-reminder-btn">Cancel</button>
        </div>
      `;

        // Hide the card body and show the form
        eventCard.querySelector('.event-card-body').style.display = 'none';
        eventCard.appendChild(reminderForm);

        // Save Reminder Logic
        reminderForm.querySelector('.save-reminder-btn').addEventListener('click', async () => {
          const hours = parseInt(reminderForm.querySelector('.reminder-hours').value) || 0;
          const minutes = parseInt(reminderForm.querySelector('.reminder-minutes').value) || 0;
          const reminderTime = `${hours}:${minutes}`;

          if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
            alert('Please enter a valid time (0-23 hours and 0-59 minutes)');
            return;
          }

          try {
            const response = await fetch(`http://localhost:8081/api/Update_Reminder/${eventId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ reminderTime }),
              credentials: 'include'
            });

            if (response.ok) {
              const result = await response.text();
              if (result === "SUCCESS") {
                alert('Reminder Updated Successfully!');
                location.reload(); // Refresh to show changes
              } else {
                alert('Failed to update reminder: ' + result);
              }
            }
          } catch (error) {
            console.error('Error updating reminder:', error);
            alert('An error occurred while updating the reminder');
          }
        });

        // Cancel Logic
        reminderForm.querySelector('.cancel-reminder-btn').addEventListener('click', () => {
          eventCard.removeChild(reminderForm);
          eventCard.querySelector('.event-card-body').style.display = 'block';
        });
      });
    });
  }



  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }


</script>
</body>
</html>